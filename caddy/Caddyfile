# Simple caddy config, handles SSL and forwards everything to varnish
{$PUBLIC_HOSTNAME} {
  import snippets/self-signed.snippet

  route /btracker_api/ {
    uri strip_prefix /btracker_api
    reverse_proxy balance-tracker-swagger:8080 {
      header_up Host {http.request.host}
      header_up X-Real-IP {http.request.remote}
    }
  }

  # Route all POST calls to the root URL to jussi (assume they're old-style JSON-RPC calls)
  @post_to_root {
    method POST
    path /
  }
  reverse_proxy @post_to_root http://jussi:9000

  # Route everything else (mostly new-style REST calls)
  reverse_proxy http://varnish
}
