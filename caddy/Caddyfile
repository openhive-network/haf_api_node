# Simple caddy config, handles SSL and forwards everything to varnish
{$PUBLIC_HOSTNAME} {
  # Import a snippet that will generate a self-signed certificate by default.
  # To generate a real certificate, bind-mount an empty file here and then
  # put your real TLS config in a file in the snippets directory
  import tls-self-signed-snippets/*.snippet

  import snippets/*.snippet

  # Route all POST calls to the root URL to jussi (assume they're old-style JSON-RPC calls)
  @post_to_root {
    method POST
    path /
  }
  reverse_proxy @post_to_root http://jussi:9000

  handle_path /admin/* {
    import admin-snippets/*.snippet

    # Route /admin/pgadmin to pgAdmin
    redir /pgadmin /admin/pgadmin/
    handle_path /pgadmin/* {
      reverse_proxy http://pgadmin {
        header_up X-Script-Name "/admin/pgadmin"
      }
    }

    # Route /admin/pgadmin to pghero
    redir /pghero /admin/pghero/
    handle_path /pghero/* {
      rewrite * /admin/pghero{uri}
      reverse_proxy http://pghero:8080
    }

    # Route /admin/haproxy to haproxy's stats page
    redir /haproxy /admin/haproxy/
    handle_path /haproxy/* {
      rewrite * /admin/haproxy{uri}
      reverse_proxy http://haproxy:8000
    }
    root * /etc/caddy/admin_html
    file_server
  }

  # Route everything else (mostly new-style REST calls)
  reverse_proxy http://varnish
}
