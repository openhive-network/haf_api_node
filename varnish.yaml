services:
  varnish:
    image: varnish:7.3.0-alpine
    profiles:
      - servers
    volumes:
      - type: bind
        source: ./varnish/default.vcl
        target: /etc/varnish/default.vcl
        read_only: true
    tmpfs:
      - /var/lib/varnish/varnishd:exec
    environment:
      - VARNISH_SIZE=2G
    depends_on:
      haproxy:
        condition: service_healthy
    networks:
      - haf-network
    # when varnish is run as a non-root user, it will run correctly the first time,
    # but fail with "Error: Cannot create test-file ..." after a restart.  See:
    #   https://github.com/varnish/docker-varnish/issues/53
    user: root
