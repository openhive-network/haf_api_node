# Alternate configuration for HAproxy, to be used when HAF API node is not
# meant to work with all the blocks (eg. on CI where it has only 5'000'000 blocks). 
global
  daemon
  log stdout format raw local0 debug
  stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
  ca-base /etc/ssl/certs
  presetenv SYNC_BROADCAST_BACKEND_SERVER api.hive.blog
  presetenv SYNC_BROADCAST_BACKEND_PORT 443
  presetenv SYNC_BROADCAST_BACKEND_SSL ssl 

defaults
  log     global
  mode    http
  option  httplog
  option  dontlognull
  option  forwardfor
  option  http-server-close
  option  log-health-checks
  timeout connect 5s
  timeout client  30s
  timeout server  30s
  timeout tunnel  1h
  default-server init-addr last,libc,none resolvers docker check
  #errorfile 400 /etc/haproxy/errors/400.http
  #errorfile 403 /etc/haproxy/errors/403.http
  #errorfile 408 /etc/haproxy/errors/408.http
  #errorfile 500 /etc/haproxy/errors/500.http
  #errorfile 502 /etc/haproxy/errors/502.http
  #errorfile 503 /etc/haproxy/errors/503.http
  #errorfile 504 /etc/haproxy/errors/504.http

resolvers docker
  parse-resolv-conf

frontend stats
  bind *:8000
  stats enable
  stats uri /admin/haproxy/
  stats refresh 10s
  stats admin if TRUE

frontend health
  bind 127.0.0.1:8001
  mode http
  http-request return status 200 if { src 127.0.0.0/8 }

####
#### Hive Frontends
####

frontend hived-in-7001
  bind *:7001
  option http-server-close
  default_backend hived

frontend hivemind-in-7002
  bind *:7002
  option http-server-close
  default_backend hivemind

frontend hafah-in-7003
  bind *:7003
  option http-server-close
  default_backend hafah

frontend balance-tracker-in-7004
  bind *:7004
  option http-server-close
  default_backend balance-tracker

frontend block-explorer-in-7005
  bind *:7005
  option http-server-close
  default_backend block-explorer

frontend sync-hived-in-7006
  bind *:7006
  option http-server-close
  default_backend sync-hived

frontend hived-in-http-7008
  bind *:7008
  option http-server-close
  default_backend hived-http

backend hived
  balance roundrobin
  server haf haf:8090 check

backend hived-http
  balance roundrobin
  server haf haf:8091 check

backend balance-tracker
  balance roundrobin
  option httpchk
  http-check expect status 200
  server balance-tracker-postgrest balance-tracker-postgrest:3000 check

backend reputation-tracker
  balance roundrobin
  option httpchk
  http-check expect status 200
  server reputation-tracker-postgrest reputation-tracker-postgrest:3000 check

backend hafah
  balance roundrobin
  option httpchk
  http-check send meth GET  uri /rpc/get_version
  server hafah-postgrest hafah-postgrest:3000 check

backend hivemind
  balance roundrobin
  option httpchk
  http-check send meth POST  uri /  hdr Content-Type application/json  body "{ \"jsonrpc\":\"2.0\", \"method\":\"condenser_api.get_trending_tags\", \"id\":1 }"
  http-check expect status 200
  server hivemind hivemind-server:8080 check

backend block-explorer
  balance roundrobin
  option httpchk
  http-check expect status 200
  server block-explorer block-explorer-postgrest:3000 check

backend sync-hived
  balance roundrobin
  server sync-hived "$SYNC_BROADCAST_BACKEND_SERVER":"$SYNC_BROADCAST_BACKEND_PORT" check "$SYNC_BROADCAST_BACKEND_SSL" ca-file ca-certificates.crt
