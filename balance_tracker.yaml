services:
  balance-tracker-setup:
    image: ${BACKEND_SETUP_REGISTRY:-registry.gitlab.syncad.com/hive/balance_tracker}:${BALANCE_TRACKER_SETUP_VERSION:-latest}
    profiles:
      - apps
      - hafbe
    environment:
      POSTGRES_HOST: haf
    networks:
      haf-network:
    command:
      - setup_db
    depends_on:
      haf:
        condition: service_healthy
  balance-tracker-drop-db:
    image: ${BACKEND_SETUP_REGISTRY:-registry.gitlab.syncad.com/hive/balance_tracker}:${BALANCE_TRACKER_SETUP_VERSION:-latest}
    profiles:
      - balance-tracker-drop-db
    environment:
      POSTGRES_HOST: haf
    networks:
      haf-network:
    command:
      - drop_db
    depends_on:
      balance-tracker-setup:
        condition: service_completed_successfully
  balance-tracker-block-processing:
    image: ${BACKEND_BLOCK_PROCESSING_REGISTRY:-registry.gitlab.syncad.com/hive/balance_tracker}:${BALANCE_TRACKER_BLOCK_PROCESSING_VERSION:-latest}
    profiles:
      - balance-tracker-standalone
    environment:
      POSTGRES_HOST: haf
    networks:
      haf-network:
    command:
      - process_blocks
    healthcheck:
      test: ["CMD-SHELL","/app/block-processing-healthcheck.sh"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 48h
    depends_on:
      balance-tracker-setup:
        condition: service_completed_successfully
  balance-tracker-postgrest:
    image: ${POSTGREST_REGISTRY:-postgrest/postgrest}:${POSTGREST_VERSION:-latest}
    profiles:
      - apps
    environment:
      PGRST_ADMIN_SERVER_PORT: 3001
      PGRST_DB_URI: postgresql://haf_app_admin@haf/haf_block_log
      PGRST_DB_SCHEMA: btracker_app
      PGRST_DB_ANON_ROLE: btracker_user
      PGRST_DB_POOL: 20
      PGRST_DB_POOL_ACQUISITION_TIMEOUT: 10
      PGRST_OPENAPI_SERVER_PROXY_URI: http://${PUBLIC_HOSTNAME}/btracker_api/
    networks:
      haf-network:
    depends_on:
      haf:
        condition: service_healthy
  balance-tracker-swagger:
    image: ${SWAGGER_REGISTRY:-swaggerapi/swagger-ui}:${SWAGGER_VERSION:-latest}
    profiles:
      - apps
    environment:
      API_URL: http://${PUBLIC_HOSTNAME}/btracker_api/
    networks:
      haf-network:
    #healthcheck:
    #  test: ["CMD-SHELL","curl -f localhost:8080"]
    depends_on:
      balance-tracker-postgrest:
        condition: service_started
          #balance-tracker-agent-check:
          #  image: alpine:3.18.3
          #  entrypoint:
